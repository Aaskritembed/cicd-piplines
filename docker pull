stages:
  - build
  - security
  - release
  - cleanup
  - SstoServer
  - docker-pull
  - docker-run

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1

cache:
  paths:
    - node_modules/

docker-build:
  stage: build
  script:
    - echo "Building Docker image using host system Docker..."
    - docker build -t anvex-speak-dashboard:$CI_COMMIT_REF_SLUG .
    - echo "Docker image built successfully"
    - docker images
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

trivy-scan:
  stage: security
  script:
    - echo "Running Trivy scan and generating JSON report..."
    - trivy image --format json --output trivy-report.json --no-progress anvex-speak-dashboard:$CI_COMMIT_REF_SLUG
    - echo "Trivy JSON report generated"
  artifacts:
    paths:
      - trivy-report.json
    when: always
    expire_in: 7 days
  needs:
    - job: docker-build
      artifacts: false
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

docker-push:
  stage: release
  script:
    - echo "Logging in to Docker Hub..."
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin

    - echo "Tagging image for Docker Hub..."
    - docker tag anvex-speak-dashboard:$CI_COMMIT_REF_SLUG $DOCKER_HUB_USERNAME/anvex-speak-dashboard:$CI_COMMIT_REF_SLUG

    - echo "Pushing image to Docker Hub..."
    - docker push $DOCKER_HUB_USERNAME/anvex-speak-dashboard:$CI_COMMIT_REF_SLUG

    - echo "Docker image pushed successfully!"
  needs:
    - trivy-scan
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

docker-cleanup:
  stage: cleanup
  script:
    - echo "üßπ Cleaning Docker on GitLab Runner..."
    - docker container prune -f
    - docker image prune -af
    - docker volume prune -f
    - docker system prune -f
    - echo "‚úÖ Docker cleanup completed."
  when: always
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

server-ssh:
  stage: SstoServer
  script:
    - echo "üîê Connecting to server..."
    - ssh -o StrictHostKeyChecking=no anvex@172.16.16.160 "whoami && hostname && docker ps"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

docker-pull:
  stage: docker-pull
  script:
    - echo "üì• Pulling Docker image on server..."
    - docker pull $DOCKER_HUB_USERNAME/anvex-speak-dashboard:$CI_COMMIT_REF_SLUG
    - docker images | head -n 5
  needs:
    - docker-push
    - server-ssh
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'


docker-run:
  stage: docker-run
  script:
    - echo "Running container on server..."
    - docker stop anvex-speak-dashboard || true
    - docker rm anvex-speak-dashboard || true
    - echo "‚ñ∂ Starting new container..."
    - docker run -d --name anvex-speak-dashboard -p 3000:3000 --restart unless-stopped "$DOCKER_HUB_USERNAME/anvex-speak-dashboard:$CI_COMMIT_REF_SLUG"
    - echo "üì¶ Container status:"
    - docker ps
  needs:
    - docker-pull
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'



stages:
  - linting
  - sonar
  - build
  - security
  - release
  - cleanup
  - SstoServer
  - docker-pull
  - docker-run

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1

cache:
  paths:
    - node_modules/

linting:
  stage: linting
  before_script:
    - npm install
    - npm install eslint-formatter-html --save-dev
  script:
    - echo "Running ESLint..."
    - npx eslint . -f json -o eslint-report.json || true
    - npx eslint . -f html -o eslint-report.html || true
    - npx eslint . -f stylish || true
  artifacts:
    when: always
    paths:
      - eslint-report.json
      - eslint-report.html
    expire_in: 1 week

sonar_scan:
  stage: sonar
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  script:
    - sonar-scanner -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.sources=. -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_LOGIN
  only:
    - main


build:
  stage: build
  before_script:
    - npm install
  script:
    - echo "Building application..."
    - npm run build
    - echo "Building Docker image..."
    - docker build -t anvex-speak-dashboard:$CI_COMMIT_REF_SLUG .
    - echo "Docker image built successfully"
    - docker images
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

security:
  stage: security
  script:
    - echo "Running Trivy scan..."
    - trivy image --format json --output trivy-report.json --no-progress anvex-speak-dashboard:$CI_COMMIT_REF_SLUG
    - echo "Trivy scan completed"
  artifacts:
    paths:
      - trivy-report.json
    when: always
    expire_in: 7 days
  needs:
    - job: build
      artifacts: false
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

release:
  stage: release
  script:
    - echo "Logging in to Docker Hub..."
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    - echo "Tagging image for Docker Hub..."
    - docker tag anvex-speak-dashboard:$CI_COMMIT_REF_SLUG $DOCKER_HUB_USERNAME/anvex-speak-dashboard:$CI_COMMIT_REF_SLUG
    - echo "Pushing image to Docker Hub..."
    - docker push $DOCKER_HUB_USERNAME/anvex-speak-dashboard:$CI_COMMIT_REF_SLUG
    - echo "Docker image pushed successfully!"
  needs:
    - security
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

cleanup:
  stage: cleanup
  script:
    - echo "Cleaning Docker on GitLab Runner..."
    - docker container prune -f
    - docker image prune -af
    - docker volume prune -f
    - docker system prune -f
    - echo "Docker cleanup completed."
  when: always
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

SstoServer:
  stage: SstoServer
  script:
    - echo "Connecting to server..."
    - ssh -o StrictHostKeyChecking=no anvex@172.16.16.160 "whoami && hostname && docker ps"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

docker-pull:
  stage: docker-pull
  script:
    - echo "Pulling Docker image on server..."
    - docker pull $DOCKER_HUB_USERNAME/anvex-speak-dashboard:$CI_COMMIT_REF_SLUG
    - docker images | head -n 5
  needs:
    - release
    - SstoServer
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

docker-run:
  stage: docker-run
  script:
    - echo "Running container on server..."
    - echo "Stopping old container if exists..."
    - docker stop anvex-speak-dashboard || true
    - docker rm anvex-speak-dashboard || true
    - echo "Starting new container..."
    - docker run -d --name anvex-speak-dashboard -p 3000:3000 --restart unless-stopped $DOCKER_HUB_USERNAME/anvex-speak-dashboard:$CI_COMMIT_REF_SLUG
    - echo "Container status:"
    - docker ps
  needs:
    - docker-pull
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

